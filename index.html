<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Estande - Soja</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2e7d32">

  <style>
    :root{--bg:#f4f4f4;--card:#fff;--muted:#666;--accent:#2e7d32;--radius:8px;--gap:8px}
    html,body{height:100%;margin:0}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);padding:18px;color:#111}
    h1{margin:0 0 14px 0;font-size:20px}
    .section{background:var(--card);padding:14px;border-radius:var(--radius);margin-bottom:14px;box-shadow:0 1px 3px rgba(0,0,0,0.06)}
    label{display:block;font-weight:600;margin-top:8px}
    input,select,textarea,button{width:100%;padding:10px;margin-top:6px;box-sizing:border-box;border:1px solid #ddd;border-radius:6px;font-size:15px;background:#fff}
    textarea{resize:vertical}
    .linha{display:flex;gap:var(--gap);align-items:center;flex-wrap:wrap;margin-top:6px}
    .linha input{flex:1 1 18%;min-width:64px;padding:8px;text-align:center}
    .ponto{border:1px solid #e6e6e6;padding:12px;border-radius:8px;margin-top:12px;background:#fafafa}
    .coord-btn{margin-top:10px;padding:10px;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer}
    .coord-display{font-size:13px;margin-top:6px;color:#444}
    .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .controls button{flex:1;padding:10px;border:none;border-radius:6px;cursor:pointer}
    .controls .primary{background:var(--accent);color:#fff}
    .controls .secondary{background:#666;color:#fff}
    @media(max-width:600px){ .linha input{flex:1 1 48%} .row{flex-direction:column} .controls{flex-direction:column} }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <h1>Controle de Estande - Soja</h1>

  <div class="section">
    <label>Responsável Técnico</label>
    <input id="responsavel" placeholder="Nome do responsável técnico" autocomplete="name">

    <label>Talhão</label>
    <select id="talhao"><option value="">Selecione...</option></select>

    <label>Área do talhão (ha)</label>
    <input id="area" type="number" readonly>

    <label>Espaçamento entre linhas (cm)</label>
    <input id="espacamento" type="number" value="45" min="5">

    <label>Quantidade de pontos (1 ponto a cada 40 ha)</label>
    <input id="qtdPontos" type="number" readonly>
  </div>

  <div id="pontosContainer"></div>

  <div class="section controls">
    <button class="primary" onclick="calcularPopulacao()">Calcular População (plants/ha)</button>
    <button class="secondary" onclick="gerarPDF()">Gerar Relatório em PDF</button>
  </div>

  <div class="section">
    <label>Resultado - População estimada (plants/ha)</label>
    <input id="resultadoPopulacao" readonly>
  </div>

<script>
/* ================== TALHÕES ================== */
const talhaoAreas = {
  "XIG.JAI.B01.T01": 101.35,"XIG.JAI.B01.T02": 232.71,"XIG.JAI.B01.T03": 263.19,
  "XIG.JAI.B02.T04": 182.29,"XIG.JAI.B02.T05": 281.13,"XIG.JAI.B02.T06": 322.21,
  "XIG.JAI.B03.T07": 289.34,"XIG.JAI.B03.T08": 190.62,"XIG.JAI.B03.T09": 458.33,
  "XIG.JAI.B04.T10": 249.21,"XIG.JAI.B05.T11": 320.88,"XIG.JAI.B05.T12": 234.11,
  "XIG.JAI.B05.T13": 181.34,"XIG.JAI.B04.T14": 301.32,"XIG.JAI.B04.T15": 243.86,
  "XIG.JAI.B04.T16": 179.15,"XIG.JAI.B05.T17": 239.50,"XIG.JAI.B05.T18": 230.99,
  "XIG.JAI.B05.T19": 105.76,"XIG.JAI.B06.T20": 52.99,"XIG.JAI.B06.T21": 154.06,
  "XIG.JAI.B06.T22": 91.23,"XIG.MAM.B01.T01": 213.20,"XIG.MAM.B01.T02": 138.12,
  "XIG.MAM.B01.T03": 209.32,"XIG.MAM.B02.T04": 85.52,"XIG.NSA.B01.T01": 185.81,
  "XIG.NSA.B01.T02": 162.25,"XIG.NSA.B01.T03": 185.58,"XIG.NSA.B01.T04": 160.22,
  "XIG.NSA.B01.T05": 269.38,"XIG.NSA.B02.T06": 247.32,"XIG.NSA.B02.T07": 258.16,
  "XIG.NSA.B02.T08": 342.79,"XIG.NSA.B02.T09": 269.56,"XIG.SO1.B01.T01": 331.02,
  "XIG.SO1.B01.T02": 298.14,"XIG.SO1.B01.T03": 246.06,"XIG.SO1.B03.T04": 268.74,
  "XIG.SO1.B03.T05": 200.82,"XIG.SO1.B02.T06": 404.92,"XIG.SO1.B02.T07": 275.67,
  "XIG.SO2.B01.T01": 189.04,"XIG.SO2.B02.T02": 217.93,"XIG.SO2.B02.T03": 295.56,
  "XIG.SO2.B01.T04": 346.18,"XIG.SO2.B01.T05": 213.62,"XIG.SO2.B03.T06": 166.29,
  "XIG.SO2.B03.T07": 303.40,"XIG.STE.B01.T01": 124.68,"XIG.STE.B02.T02": 303.20,
  "XIG.STE.B03.T03": 300.19,"XIG.STE.B03.T04": 365.53,"XIG.STE.B02.T05": 281.90,
  "XIG.STE.B02.T06": 180.08
};

document.addEventListener("DOMContentLoaded", () => {
  const sel = document.getElementById("talhao");
  Object.keys(talhaoAreas).forEach(k => {
    const o = document.createElement("option");
    o.value = k;
    o.textContent = k;
    sel.appendChild(o);
  });
  sel.addEventListener("change", selecionarArea);
});

function selecionarArea(){
  const talhao = document.getElementById("talhao").value;
  document.getElementById("area").value = talhaoAreas[talhao] || "";
  calcularPontos();
}

/* ================== GERAR PONTOS ================== */
function calcularPontos(){
  const area = parseFloat(document.getElementById("area").value) || 0;
  const qtd = Math.max(1, Math.ceil(area / 40));
  document.getElementById("qtdPontos").value = qtd;
  gerarPontos(qtd);
}

function gerarPontos(qtd){
  const container = document.getElementById("pontosContainer");
  container.innerHTML = "";

  for (let i = 1; i <= qtd; i++){
    const d = document.createElement("div");
    d.className = "ponto";

    d.innerHTML = `
      <h3>Ponto ${i}</h3>

      <label>Fase Fenológica</label>
      <select class="fase">
        <option value="">Selecione...</option>
        <option>VE</option><option>V1</option><option>V2</option><option>V3</option>
        <option>V4</option><option>V5</option><option>V6+</option>
        <option>R1</option><option>R2</option><option>R3</option>
        <option>R4</option><option>R5</option><option>R6</option>
      </select>

      <label>Contagem de plantas (5 linhas de 5 m)</label>
      <div class="linha">
        <input class="l1" type="number" min="0">
        <input class="l2" type="number" min="0">
        <input class="l3" type="number" min="0">
        <input class="l4" type="number" min="0">
        <input class="l5" type="number" min="0">
      </div>

      <label>Média (plantas/m)</label>
      <input class="media" readonly>

      <button class="coord-btn" onclick="registrarCoordenada(this)">Registrar Coordenada (GPS)</button>
      <div class="coord-display"></div>

      <label>Fotos (máx 5 / 10MB cada)</label>
      <input type="file" class="fotos" accept="image/*" multiple onchange="validarFotos(this)">

      <label>Observações - Daninhas</label>
      <textarea class="obs-dan"></textarea>

      <label>Observações - Pragas & Doenças</label>
      <textarea class="obs-prag"></textarea>

      <label>Nódulos - Raiz Principal</label>
      <input class="nod-principal">

      <label>Nódulos - Raízes Secundárias</label>
      <input class="nod-secundarias">
    `;

    container.appendChild(d);

    d.querySelectorAll(".linha input")
      .forEach(el => el.addEventListener("input", () => atualizarMedia(d)));
  }
}

/* ================== MÉDIAS ================== */
function atualizarMedia(div){
  const vals = [...div.querySelectorAll(".linha input")].map(i => Number(i.value) || 0);
  const media = vals.reduce((a,b)=>a+b,0) / 25;
  div.querySelector(".media").value = media.toFixed(1);
}

/* ================== COORDENADAS ================== */
function registrarCoordenada(btn){
  const target = btn.parentElement.querySelector(".coord-display");
  navigator.geolocation.getCurrentPosition(
    pos => target.textContent = `Lat: ${pos.coords.latitude.toFixed(6)}, Lon: ${pos.coords.longitude.toFixed(6)}`,
    err => alert("Erro: " + err.message),
    { enableHighAccuracy:true, timeout:10000 }
  );
}

/* ================== LIMITAR FOTOS ================== */
function validarFotos(input){
  if (!input.files) return;
  if (input.files.length > 5){
    alert("Limite de 5 fotos");
    input.value = "";
    return;
  }
  for (const f of input.files)
    if (f.size > 10*1024*1024){
      alert("Cada foto deve ter no máximo 10MB");
      input.value = "";
      return;
    }
}

/* ================== POPULAÇÃO ================== */
function coletarMedias(){
  return [...document.querySelectorAll(".ponto")].map(p=>{
    const m = parseFloat(p.querySelector(".media").value);
    return isNaN(m)?null:m;
  });
}

function calcularPopulacao(){
  const medias = coletarMedias();
  if (medias.some(m=>m===null)){
    alert("Preencha todos os pontos");
    return;
  }

  const esp = (parseFloat(document.getElementById("espacamento").value)||45)/100;
  const mediaGeral = medias.reduce((a,b)=>a+b,0) / medias.length;
  const pop = Math.round(mediaGeral * (10000/esp));

  document.getElementById("resultadoPopulacao").value = pop;
  return pop;
}

/* ================== PDF ================== */
function fileToDataURL(f, maxSide=1200){
  return new Promise(res=>{
    const fr=new FileReader();
    fr.onload=()=>{
      const img=new Image();
      img.onload=()=>{
        let w=img.width, h=img.height;
        if (Math.max(w,h) > maxSide){
          const r = maxSide/Math.max(w,h);
          w*=r; h*=r;
        }
        const c=document.createElement("canvas");
        c.width=w; c.height=h;
        c.getContext("2d").drawImage(img,0,0,w,h);
        res(c.toDataURL("image/jpeg",0.85));
      };
      img.src=fr.result;
    };
    fr.readAsDataURL(f);
  });
}

async function gerarPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","mm","a4");
  let y = 12;

  doc.setFontSize(14);
  doc.text("Relatório - Controle de Estande (Soja)", 14, y);
  y+=10;

  doc.setFontSize(10);
  doc.text(`Responsável: ${document.getElementById("responsavel").value}`,14,y); y+=6;
  doc.text(`Talhão: ${document.getElementById("talhao").value}`,14,y); y+=6;
  doc.text(`Área: ${document.getElementById("area").value} ha`,14,y); y+=6;

  const pontos = [...document.querySelectorAll(".ponto")];

  for (let i=0;i<pontos.length;i++){
    const p = pontos[i];

    doc.setFontSize(12);
    doc.text(`Ponto ${i+1}`,14,y); y+=6;

    doc.setFontSize(10);

    doc.text(`Fase: ${p.querySelector(".fase").value||"-"}`,14,y); y+=6;

    ["l1","l2","l3","l4","l5"].forEach((l,ix)=>{
      doc.text(`Linha ${ix+1}: ${p.querySelector("."+l).value||0}`,14,y);
      y+=5;
    });
    y+=2;

    doc.text(`Média: ${p.querySelector(".media").value}`,14,y); y+=6;

    doc.text(`Coord: ${p.querySelector(".coord-display").textContent||"-"}`,14,y); y+=6;

    doc.text(`Daninhas: ${p.querySelector(".obs-dan").value||"-"}`,14,y); y+=6;
    doc.text(`Pragas: ${p.querySelector(".obs-prag").value||"-"}`,14,y); y+=6;
    doc.text(`Nód. Principal: ${p.querySelector(".nod-principal").value||"-"}`,14,y); y+=6;
    doc.text(`Nód. Secundárias: ${p.querySelector(".nod-secundarias").value||"-"}`,14,y); y+=8;

    const fotos = p.querySelector(".fotos").files;
    if (fotos.length){
      for (const f of fotos){
        const dataUrl = await fileToDataURL(f);
        const img = new Image();
        img.src = dataUrl;
        await new Promise(r=>img.onload=r);

        let wmm = img.width * 0.2645;
        let hmm = img.height * 0.2645;
        const ratio = Math.min(180/wmm, 120/hmm, 1);
        wmm*=ratio; hmm*=ratio;

        if (y + hmm > 280){ doc.addPage(); y=12; }

        doc.addImage(dataUrl, "JPEG", 14, y, wmm, hmm);
        y+=hmm+6;
      }
    }

    if (y > 260){ doc.addPage(); y=12; }
  }

  doc.save("relatorio_estande.pdf");
}

/* ================== SERVICE WORKER ================== */
if ('serviceWorker' in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>
</body>
</html>
