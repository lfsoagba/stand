<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Controle de Estande - Soja</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2e7d32">

  <style>
    :root{--bg:#f4f4f4;--card:#fff;--muted:#666;--accent:#2e7d32;--radius:8px;--gap:8px}
    body{font-family:Arial;background:var(--bg);margin:0;padding:18px}
    h1{font-size:20px;margin-bottom:12px}
    .section{background:#fff;padding:14px;border-radius:8px;margin-bottom:14px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    label{font-weight:600;margin-top:10px;display:block}
    input,select,textarea{width:100%;padding:10px;margin-top:6px;border:1px solid #ccc;border-radius:6px}
    textarea{resize:vertical}
    .linha{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
    .linha input{flex:1 1 18%;min-width:64px;text-align:center}
    .ponto{padding:14px;border:1px solid #ddd;border-radius:8px;background:#fafafa;margin-top:14px}
    .coord-btn{padding:10px;background:var(--accent);border:none;color:#fff;border-radius:6px;margin-top:10px;cursor:pointer}
    .foto-actions{display:flex;gap:8px;margin-top:8px}
    .foto-actions button{flex:1;padding:8px;border-radius:6px;border:none;background:#2e7d32;color:white}
    .controls{display:flex;gap:10px;margin-top:10px}
    .controls button{flex:1;padding:12px;font-size:16px;border:none;border-radius:6px;color:white}
    .primary{background:#2e7d32}
    .secondary{background:#444}
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
<h1>Controle de Estande - Soja</h1>

<!-- Cabeçalho -->
<div class="section">
  <label>Responsável Técnico</label>
  <input id="responsavel">

  <label>Talhão</label>
  <select id="talhao"><option value="">Selecione...</option></select>

  <label>Área do talhão (ha)</label>
  <input id="area" readonly>

  <label>Espaçamento entre linhas (cm)</label>
  <input id="espacamento" type="number" value="45">

  <label>Quantidade de pontos</label>
  <input id="qtdPontos" readonly>
</div>

<!-- Pontos -->
<div id="pontosContainer"></div>

<!-- Botões -->
<div class="section controls">
  <button class="primary" onclick="calcularPopulacao()">Calcular População</button>
  <button class="secondary" onclick="gerarPDF()">Gerar PDF</button>
</div>

<div class="section">
  <label>População estimada (plantas/ha)</label>
  <input id="resultadoPopulacao" readonly>
</div>

<script>
/* === Talhões === */
const talhaoAreas = {
  "XIG.JAI.B01.T01":101.35,"XIG.JAI.B01.T02":232.71,"XIG.JAI.B01.T03":263.19,
  "XIG.JAI.B02.T04":182.29,"XIG.JAI.B02.T05":281.13,"XIG.JAI.B02.T06":322.21,
  "XIG.JAI.B03.T07":289.34,"XIG.JAI.B03.T08":190.62,"XIG.JAI.B03.T09":458.33,
  "XIG.JAI.B04.T10":249.21,"XIG.JAI.B05.T11":320.88,"XIG.JAI.B05.T12":234.11,
  "XIG.JAI.B05.T13":181.34,"XIG.JAI.B04.T14":301.32,"XIG.JAI.B04.T15":243.86,
  "XIG.JAI.B04.T16":179.15,"XIG.JAI.B05.T17":239.50,"XIG.JAI.B05.T18":230.99,
  "XIG.JAI.B05.T19":105.76,"XIG.JAI.B06.T20":52.99,"XIG.JAI.B06.T21":154.06,
  "XIG.JAI.B06.T22":91.23,"XIG.MAM.B01.T01":213.20,"XIG.MAM.B01.T02":138.12,
  "XIG.MAM.B01.T03":209.32,"XIG.MAM.B02.T04":85.52,"XIG.NSA.B01.T01":185.81,
  "XIG.NSA.B01.T02":162.25,"XIG.NSA.B01.T03":185.58,"XIG.NSA.B01.T04":160.22,
  "XIG.NSA.B01.T05":269.38,"XIG.NSA.B02.T06":247.32,"XIG.NSA.B02.T07":258.16,
  "XIG.NSA.B02.T08":342.79,"XIG.NSA.B02.T09":269.56,"XIG.SO1.B01.T01":331.02,
  "XIG.SO1.B01.T02":298.14,"XIG.SO1.B01.T03":246.06,"XIG.SO1.B03.T04":268.74,
  "XIG.SO1.B03.T05":200.82,"XIG.SO1.B02.T06":404.92,"XIG.SO1.B02.T07":275.67,
  "XIG.SO2.B01.T01":189.04,"XIG.SO2.B02.T02":217.93,"XIG.SO2.B02.T03":295.56,
  "XIG.SO2.B01.T04":346.18,"XIG.SO2.B01.T05":213.62,"XIG.SO2.B03.T06":166.29,
  "XIG.SO2.B03.T07":303.40,"XIG.STE.B01.T01":124.68,"XIG.STE.B02.T02":303.20,
  "XIG.STE.B03.T03":300.19,"XIG.STE.B03.T04":365.53,"XIG.STE.B02.T05":281.90,
  "XIG.STE.B02.T06":180.08
};

/* === Monta dropdown === */
document.addEventListener("DOMContentLoaded", () => {
  const sel = document.getElementById("talhao");
  Object.keys(talhaoAreas).forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    sel.appendChild(opt);
  });
  sel.onchange = selecionarArea;
});

/* === Seleção de talhão === */
function selecionarArea(){
  const t = document.getElementById("talhao").value;
  document.getElementById("area").value = talhaoAreas[t] || "";
  calcularPontos();
}

/* === Calcula nº de pontos === */
function calcularPontos(){
  const area = parseFloat(document.getElementById("area").value)||0;
  const pontos = Math.max(1, Math.ceil(area/40));
  document.getElementById("qtdPontos").value = pontos;
  gerarPontos(pontos);
}

/* === Gera os blocos dos pontos === */
function gerarPontos(qtd){
  const cont = document.getElementById("pontosContainer");
  cont.innerHTML = "";

  for(let i=1; i<=qtd; i++){
    const div = document.createElement("div");
    div.className = "ponto";

    div.innerHTML = `
      <h3>Ponto ${i}</h3>

      <label>Fase Fenológica</label>
      <select class="fase">
        <option value="">Selecione...</option>
        <option>VE</option><option>V1</option><option>V2</option><option>V3</option>
        <option>V4</option><option>V5</option><option>V6+</option>
        <option>R1</option><option>R2</option><option>R3</option><option>R4</option>
        <option>R5</option><option>R6</option>
      </select>

      <label>Contagem (5 linhas de 5 m)</label>
      <div class="linha">
        <input class="l1" type="number" min="0" placeholder="L1">
        <input class="l2" type="number" min="0" placeholder="L2">
        <input class="l3" type="number" min="0" placeholder="L3">
        <input class="l4" type="number" min="0" placeholder="L4">
        <input class="l5" type="number" min="0" placeholder="L5">
      </div>

      <label>Média (plantas/m)</label>
      <input class="media" readonly>

      <button class="coord-btn" onclick="registrarGPS(this)">Registrar Coordenadas</button>
      <div class="coord-display"></div>

      <label>Fotos (máx 5)</label>
      <input type="file" class="fotos" accept="image/*" multiple onchange="validarFotos(this)">

      <div class="foto-actions">
        <button onclick="tirarFoto(this)">Tirar Foto</button>
        <button onclick="selecionarFoto(this)">Selecionar Fotos</button>
      </div>
      <div class="foto-count">0 fotos</div>

      <label>Daninhas</label>
      <textarea class="obs-dan" rows="2"></textarea>

      <label>Pragas e Doenças</label>
      <textarea class="obs-prag" rows="2"></textarea>

      <label>Nódulos – Raiz Principal</label>
      <input class="nod-principal">

      <label>Nódulos – Raízes Secundárias</label>
      <input class="nod-secundarias">
    `;

    cont.appendChild(div);

    div.querySelectorAll(".linha input").forEach(inp=>{
      inp.oninput = ()=> atualizarMedia(div);
    });
  }
}

/* === Média === */
function atualizarMedia(div){
  const vals = [...div.querySelectorAll(".linha input")].map(x=>+x.value||0);
  const media = vals.reduce((a,b)=>a+b,0) / 25;
  div.querySelector(".media").value = media.toFixed(1);
}

/* === GPS === */
function registrarGPS(btn){
  const box = btn.parentElement.querySelector(".coord-display");
  navigator.geolocation.getCurrentPosition(
    pos => box.textContent = `Lat: ${pos.coords.latitude.toFixed(6)}, Lon: ${pos.coords.longitude.toFixed(6)}`,
    err => alert("Erro: "+err.message),
    {enableHighAccuracy:true}
  );
}

/* === Fotos === */
function validarFotos(input){
  if(input.files.length > 5){
    alert("Máximo 5 fotos");
    input.value="";
  }
  atualizarContagemFotos(input);
}

function tirarFoto(btn){
  const inp = btn.closest(".ponto").querySelector(".fotos");
  inp.setAttribute("capture","environment");
  inp.click();
}

function selecionarFoto(btn){
  const inp = btn.closest(".ponto").querySelector(".fotos");
  inp.removeAttribute("capture");
  inp.click();
}

function atualizarContagemFotos(input){
  const box = input.closest(".ponto").querySelector(".foto-count");
  const qt = input.files.length;
  box.textContent = `${qt} foto${qt===1?"":"s"}`;
}

/* === População === */
function calcularPopulacao(){
  const pontos = [...document.querySelectorAll(".media")];
  const medias = pontos.map(x=>+x.value||0);
  const esp = (+document.getElementById("espacamento").value)/100;
  const mediaGeral = medias.reduce((a,b)=>a+b,0)/medias.length;
  const pop = mediaGeral * (10000/esp);
  document.getElementById("resultadoPopulacao").value = Math.round(pop);
}

/* === PDF === */
async function gerarPDF(){
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF();
  let y=10;

  doc.text("Relatório de Estande - Soja",10,y); y+=10;

  doc.text("Responsável: "+(document.getElementById("responsavel").value||"-"),10,y); y+=6;
  doc.text("Talhão: "+(document.getElementById("talhao").value||"-"),10,y); y+=6;
  doc.text("Área: "+(document.getElementById("area").value||"-")+" ha",10,y); y+=10;

  const pontos = [...document.querySelectorAll(".ponto")];

  for(let i=0;i<pontos.length;i++){
    const p = pontos[i];
    doc.text(`Ponto ${i+1}`,10,y); y+=8;

    doc.text("Fase: "+(p.querySelector(".fase").value||"-"),10,y); y+=6;

    doc.text("L1: "+p.querySelector(".l1").value,10,y); y+=5;
    doc.text("L2: "+p.querySelector(".l2").value,10,y); y+=5;
    doc.text("L3: "+p.querySelector(".l3").value,10,y); y+=5;
    doc.text("L4: "+p.querySelector(".l4").value,10,y); y+=5;
    doc.text("L5: "+p.querySelector(".l5").value,10,y); y+=8;

    doc.text("Média: "+p.querySelector(".media").value,10,y); y+=6;

    const coord = p.querySelector(".coord-display").textContent||"Não registrada";
    doc.text("Coord.: "+coord,10,y); y+=6;

    doc.text("Daninhas: "+p.querySelector(".obs-dan").value,10,y); y+=6;
    doc.text("Pragas: "+p.querySelector(".obs-prag").value,10,y); y+=6;

    doc.text("Nódulos (Principal): "+p.querySelector(".nod-principal").value,10,y); y+=6;
    doc.text("Nódulos (Secundárias): "+p.querySelector(".nod-secundarias").value,10,y); y+=10;

    if(y>260){doc.addPage(); y=10;}
  }

  doc.save("relatorio_estande.pdf");
}

/* === PWA Auto Update === */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>
</body>
</html>
