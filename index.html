<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalia√ß√£o Popula√ß√£o de Plantas</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }

        h2 {
            margin-top: 25px;
        }

        .box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        input, select, button, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        button {
            background: #0066ff;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background: #0044aa;
        }

        .foto-preview {
            width: 100%;
            max-width: 450px;
            height: auto;
            margin-top: 10px;
            border-radius: 10px;
        }
    </style>

</head>
<body>

    <h1>Avalia√ß√£o de Popula√ß√£o de Plantas</h1>

    <div class="box">
        <h2>Respons√°vel T√©cnico</h2>
        <input type="text" id="responsavel" placeholder="Nome do respons√°vel t√©cnico">
    </div>

    <div class="box">
        <h2>Talh√£o</h2>
        <select id="talhao">
            <!-- DROPDOWN CORRIGIDO -->
        </select>
    </div>

    <script>
        // üî• LISTA DE TALH√ïES QUE VOC√ä J√Å HAVIA INFORMADO
        const talhoes = [
            "Talh√£o 01 - 42,35 ha",
            "Talh√£o 02 - 37,10 ha",
            "Talh√£o 03 - 28,50 ha",
            "Talh√£o 04 - 19,80 ha"
        ];

        const select = document.getElementById("talhao");
        talhoes.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t;
            opt.textContent = t;   // <-- AGORA FUNCIONA
            select.appendChild(opt);
        });
    </script>

    <div class="box">
        <h2>Coordenadas</h2>
        <button onclick="getLocation()">Registrar Coordenada</button>
        <p id="coord"></p>
    </div>

    <script>
        let latitude = "";
        let longitude = "";

        function getLocation() {
            if (!navigator.geolocation) {
                alert("Geolocaliza√ß√£o n√£o suportada.");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                pos => {
                    latitude = pos.coords.latitude.toFixed(6);
                    longitude = pos.coords.longitude.toFixed(6);
                    document.getElementById("coord").innerText =
                        `Lat: ${latitude} | Lng: ${longitude}`;
                },
                err => {
                    alert("Erro ao obter coordenada: " + err.message);
                }
            );
        }
    </script>

    <div class="box">
        <h2>Contagem de Plantas (5 linhas √ó 5 m)</h2>

        <div id="inputs"></div>

        <button onclick="adicionarPonto()">Adicionar Ponto</button>

        <h3>M√©dias dos Pontos</h3>
        <div id="resultados"></div>
    </div>

    <script>
        let pontos = [];
        let pontoIndex = 1;

        function adicionarPonto() {
            let linhas = [];

            for (let i = 1; i <= 5; i++) {
                let valor = parseInt(document.getElementById("linha" + i)?.value || 0);
                linhas.push(valor);
            }

            let soma = linhas.reduce((a, b) => a + b, 0);
            let media = soma / 25; // 5 linhas √ó 5 metros

            media = media.toFixed(1); // üî• AGORA APENAS 1 CASA DECIMAL

            pontos.push({
                ponto: pontoIndex++,
                linhas: linhas,
                media: media
            });

            atualizarResultados();
        }

        function atualizarResultados() {
            let html = "";

            pontos.forEach(p => {
                html += `<p><b>Ponto ${p.ponto}:</b> ${p.media} plantas/m</p>`;
            });

            document.getElementById("resultados").innerHTML = html;
        }

        // Criar inputs
        let htmlInputs = "";
        for (let i = 1; i <= 5; i++) {
            htmlInputs += `
                <input type="number" id="linha${i}" placeholder="Linha ${i}">
            `;
        }
        document.getElementById("inputs").innerHTML = htmlInputs;
    </script>

    <div class="box">
        <h2>Fotos</h2>
        <input type="file" id="foto" accept="image/*" onchange="previewFoto()">
        <img id="preview" class="foto-preview">
    </div>

    <script>
        let fotoBase64 = "";

        function previewFoto() {
            const file = document.getElementById("foto").files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                fotoBase64 = e.target.result;
                document.getElementById("preview").src = fotoBase64;
            };

            reader.readAsDataURL(file);
        }
    </script>

    <button onclick="gerarPDF()">Gerar Relat√≥rio em PDF</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        async function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            pdf.setFontSize(16);
            pdf.text("Relat√≥rio de Popula√ß√£o de Plantas", 10, 10);

            pdf.setFontSize(12);
            pdf.text("Respons√°vel T√©cnico: " + document.getElementById("responsavel").value, 10, 20);
            pdf.text("Talh√£o: " + document.getElementById("talhao").value, 10, 30);

            if (latitude !== "") {
                pdf.text(`Coordenadas: ${latitude}, ${longitude}`, 10, 40);
            }

            pdf.text("Resultados dos Pontos:", 10, 55);

            let y = 65;

            pontos.forEach(p => {
                pdf.text(`Ponto ${p.ponto} - M√©dia: ${p.media} plantas/m`, 10, y);
                y += 6;

                // üî• AGORA MOSTRA AS CONTAGENS NO PDF
                pdf.text(`Linhas: ${p.linhas.join(", ")}`, 10, y);
                y += 8;
            });

            if (fotoBase64 !== "") {
                pdf.addImage(fotoBase64, "JPEG", 10, y, 120, 0); // üî• PROPOR√á√ÉO NATURAL (altura autom√°tica)
            }

            pdf.save("relatorio_populacao.pdf");
        }
    </script>

</body>
</html>
